---
title: Test Implementation Plan for `khive reader search` (Issue #28)
by: khive-implementer
created: 2025-05-22
updated: 2025-05-22
version: 1.0
doc_type: TI
output_subdir: ti
description: Test implementation plan for the `khive reader search` command and DocumentSearchService.
date: 2025-05-22
issue_ref: 28
---

# Guidance

**Purpose** Document the planned and actual test implementation. Clarify unit,
integration, performance, mocking details, and test data.

**When to Use**

- Before/during writing tests, especially if it’s a large feature or
  microservice.
- As a blueprint to ensure coverage is complete.

**Best Practices**

- Keep tests short and focused.
- Use mocking for external calls.
- Outline coverage goals.

---

# Test Implementation Plan: `khive reader search` (Issue #28)

## 1. Overview

### 1.1 Component Under Test

- `DocumentSearchService` in `src/khive/reader/services/search_service.py`
- `search` subcommand of `khive reader` in
  [`src/khive/cli/khive_reader.py`](src/khive/cli/khive_reader.py:0)

### 1.2 Test Approach

Primarily Unit Tests with mocking for external dependencies
(`EmbeddingGenerator`, `DocumentChunkRepository`). CLI tests will use
`typer.testing.CliRunner` (or `click.testing.CliRunner` if Typer is not directly
used for `reader_cli`).

### 1.3 Key Testing Goals

- Verify correct interaction between `DocumentSearchService`,
  `EmbeddingGenerator`, and `DocumentChunkRepository`.
- Ensure the `search` method of the service handles different inputs (query,
  `document_id`, `top_k`) correctly.
- Validate CLI argument parsing and command execution.
- Confirm correct output formatting for both console and JSON.
- Achieve ≥80% line coverage for new code.

## 2. Test Environment

### 2.1 Test Framework

```python
# Python
pytest
pytest-asyncio # If any part of the service or dependencies are async
pytest-mock
pytest-cov
```

### 2.2 Mock Framework

```python
# For Python
from unittest.mock import MagicMock, patch # or pytest-mock's mocker fixture
```

### 2.3 Test Database

No direct database interaction in these unit tests. The
`DocumentChunkRepository` will be mocked, abstracting away database calls.

## 3. Unit Tests

### 3.1 Test Suite: `DocumentSearchService` (`tests/reader/services/test_search_service.py`)

#### 3.1.1 Test Case: `test_search_valid_query_default_top_k`

**Purpose:** Verify basic search functionality. **Setup:**

```python
import pytest
from unittest.mock import MagicMock, patch
from uuid_extensions import uuid7 # Assuming UUIDs are used
from typing import List, Dict, Optional, Any

# Assume these are defined elsewhere or will be created
# from khive.reader.services.search_service import DocumentSearchService
# from khive.reader.embedding_generator import EmbeddingGenerator # Interface
# from khive.reader.repositories.document_chunk_repository import DocumentChunkRepository # Interface
# from khive.reader.models import DocumentChunk # Or a Dict representation

# Placeholder for actual classes until implemented
class EmbeddingGenerator:
    def generate_embedding(self, text: str) -> List[float]:
        return [0.1] * 768 # Example embedding

class DocumentChunkRepository:
    def search_similar_chunks(
        self, embedding: List[float], top_k: int, document_id: Optional[Any] = None
    ) -> List[Dict]: # Assuming DocumentChunk is dict-like for now
        return [{"id": str(uuid7()), "document_id": str(uuid7()), "text_content": "chunk text", "score": 0.9}] * top_k

class DocumentSearchService:
    def __init__(self, embedding_generator: EmbeddingGenerator, document_chunk_repository: DocumentChunkRepository):
        self.embedding_generator = embedding_generator
        self.document_chunk_repository = document_chunk_repository

    def search(self, query: str, document_id: Optional[Any] = None, top_k: int = 5) -> List[Dict]:
        query_embedding = self.embedding_generator.generate_embedding(query)
        results = self.document_chunk_repository.search_similar_chunks(
            embedding=query_embedding,
            top_k=top_k,
            document_id=document_id
        )
        # Simple formatting, actual formatting might differ
        return [{"chunk_id": r["id"], "text": r["text_content"], "score": r["score"]} for r in results]


@pytest.fixture
def mock_embedding_generator():
    mock = MagicMock(spec=EmbeddingGenerator)
    mock.generate_embedding.return_value = [0.1, 0.2, 0.3] # Example embedding
    return mock

@pytest.fixture
def mock_doc_chunk_repo():
    mock = MagicMock(spec=DocumentChunkRepository)
    # Example return value, adapt based on actual DocumentChunk structure
    mock.search_similar_chunks.return_value = [
        {"id": str(uuid7()), "document_id": str(uuid7()), "text_content": "Test chunk 1", "score": 0.95},
        {"id": str(uuid7()), "document_id": str(uuid7()), "text_content": "Test chunk 2", "score": 0.90},
    ]
    return mock

@pytest.fixture
def search_service(mock_embedding_generator, mock_doc_chunk_repo):
    return DocumentSearchService(
        embedding_generator=mock_embedding_generator,
        document_chunk_repository=mock_doc_chunk_repo
    )
```

**Test Implementation:**

```python
def test_search_valid_query_default_top_k(search_service, mock_embedding_generator, mock_doc_chunk_repo):
    query = "test query"
    results = search_service.search(query=query)

    mock_embedding_generator.generate_embedding.assert_called_once_with(query)
    mock_doc_chunk_repo.search_similar_chunks.assert_called_once_with(
        embedding=[0.1, 0.2, 0.3], # From mock_embedding_generator
        top_k=5, # Default
        document_id=None
    )
    assert len(results) == 2 # Based on mock_doc_chunk_repo return
    assert results[0]["text"] == "Test chunk 1"
```

#### 3.1.2 Test Case: `test_search_with_document_id_filter`

**Purpose:** Verify filtering by `document_id`. **Setup:** (Uses fixtures from
3.1.1) **Test Implementation:**

```python
def test_search_with_document_id_filter(search_service, mock_embedding_generator, mock_doc_chunk_repo):
    query = "filter query"
    doc_id = uuid7()
    results = search_service.search(query=query, document_id=doc_id)

    mock_embedding_generator.generate_embedding.assert_called_once_with(query)
    mock_doc_chunk_repo.search_similar_chunks.assert_called_once_with(
        embedding=[0.1, 0.2, 0.3],
        top_k=5,
        document_id=doc_id
    )
    assert len(results) == 2 # Or as per mock
```

#### 3.1.3 Test Case: `test_search_custom_top_k`

**Purpose:** Verify `top_k` parameter is respected. **Setup:** (Uses fixtures
from 3.1.1) **Test Implementation:**

```python
def test_search_custom_top_k(search_service, mock_embedding_generator, mock_doc_chunk_repo):
    query = "top_k query"
    custom_top_k = 3
    # Adjust mock to return `custom_top_k` items if needed for assertion
    mock_doc_chunk_repo.search_similar_chunks.return_value = [
        {"id": str(uuid7()), "document_id": str(uuid7()), "text_content": f"Chunk {i}", "score": 0.9}
        for i in range(custom_top_k)
    ]
    results = search_service.search(query=query, top_k=custom_top_k)

    mock_doc_chunk_repo.search_similar_chunks.assert_called_once_with(
        embedding=[0.1, 0.2, 0.3],
        top_k=custom_top_k,
        document_id=None
    )
    assert len(results) == custom_top_k
```

#### 3.1.4 Test Case: `test_search_no_results_found`

**Purpose:** Verify behavior when repository returns no chunks. **Setup:** (Uses
fixtures from 3.1.1) **Test Implementation:**

```python
def test_search_no_results_found(search_service, mock_embedding_generator, mock_doc_chunk_repo):
    mock_doc_chunk_repo.search_similar_chunks.return_value = []
    query = "empty query"
    results = search_service.search(query=query)

    assert results == []
```

#### 3.1.5 Test Case: `test_search_embedding_generator_exception` (Example)

**Purpose:** Verify exception handling from `EmbeddingGenerator`. **Setup:**
(Uses fixtures from 3.1.1) **Test Implementation:**

```python
def test_search_embedding_generator_exception(search_service, mock_embedding_generator, mock_doc_chunk_repo):
    mock_embedding_generator.generate_embedding.side_effect = ValueError("Embedding failed")
    query = "exception query"

    with pytest.raises(ValueError, match="Embedding failed"):
        search_service.search(query=query)
    mock_doc_chunk_repo.search_similar_chunks.assert_not_called()
```

### 3.2 Test Suite: `khive reader search` CLI (`tests/cli/test_khive_reader.py`)

**Setup for CLI Tests:**

```python
import json
from click.testing import CliRunner
# from khive.cli.khive_reader import reader_cli # Assuming this is the Click group
# For now, let's assume a structure for khive_reader.py
# Will need to patch DocumentSearchService instantiation within the CLI command

# Placeholder for khive_reader.py structure
# src/khive/cli/khive_reader.py
# import click
# from khive.reader.services.search_service import DocumentSearchService (placeholder)
# from khive.reader.embedding_generator import EmbeddingGenerator (placeholder)
# from khive.reader.repositories.document_chunk_repository import DocumentChunkRepository (placeholder)

# @click.group()
# def reader_cli():
#     pass

# @reader_cli.command("search")
# @click.option('--query', required=True, type=str)
# @click.option('--document-id', default=None, type=str) # Assuming UUID as str for CLI
# @click.option('--top-k', default=5, type=int)
# @click.option('--json-output', is_flag=True)
# def search_command(query, document_id, top_k, json_output):
#     # Simplified: In reality, these would be properly instantiated/injected
#     embedding_gen = EmbeddingGenerator()
#     repo = DocumentChunkRepository()
#     service = DocumentSearchService(embedding_gen, repo)
#     results = service.search(query, document_id, top_k)
#     if json_output:
#         click.echo(json.dumps(results))
#     else:
#         # Basic console output
#         for res in results:
#             click.echo(f"ID: {res.get('chunk_id', 'N/A')}, Score: {res.get('score', 0.0):.2f}, Text: {res.get('text', '')[:50]}...")

# This is a simplified CLI structure for planning tests. Actual implementation will be in the file.
```

#### 3.2.1 Test Case: `test_cli_search_basic`

**Purpose:** Test basic CLI search. **Test Implementation:**

```python
# In tests/cli/test_khive_reader.py
# from khive.cli.khive_reader import reader_cli # Actual import

def test_cli_search_basic(mocker): # mocker from pytest-mock
    runner = CliRunner()
    mock_service_instance = MagicMock()
    mock_service_instance.search.return_value = [
        {"chunk_id": "id1", "text": "CLI result 1", "score": 0.88}
    ]
    # Patch the DocumentSearchService where it's instantiated in the CLI command
    mocker.patch('khive.cli.khive_reader.DocumentSearchService', return_value=mock_service_instance)
    # Also mock EmbeddingGenerator and DocumentChunkRepository if they are directly instantiated in CLI
    mocker.patch('khive.cli.khive_reader.EmbeddingGenerator')
    mocker.patch('khive.cli.khive_reader.DocumentChunkRepository')


    # Need to import the actual reader_cli group from src.khive.cli.khive_reader
    # For now, assuming 'cli.py' contains 'reader_cli'
    from khive.cli import khive_reader # Assuming this path
    
    result = runner.invoke(khive_reader.reader_cli, ['search', '--query', 'cli test'])

    assert result.exit_code == 0
    mock_service_instance.search.assert_called_once_with(query='cli test', document_id=None, top_k=5)
    assert "CLI result 1" in result.output
```

#### 3.2.2 Test Case: `test_cli_search_json_output`

**Purpose:** Test JSON output. **Test Implementation:**

```python
def test_cli_search_json_output(mocker):
    runner = CliRunner()
    mock_service_instance = MagicMock()
    mock_search_results = [{"chunk_id": "id_json", "text": "JSON result", "score": 0.77}]
    mock_service_instance.search.return_value = mock_search_results
    mocker.patch('khive.cli.khive_reader.DocumentSearchService', return_value=mock_service_instance)
    mocker.patch('khive.cli.khive_reader.EmbeddingGenerator')
    mocker.patch('khive.cli.khive_reader.DocumentChunkRepository')

    from khive.cli import khive_reader
    result = runner.invoke(khive_reader.reader_cli, ['search', '--query', 'json test', '--json-output'])

    assert result.exit_code == 0
    mock_service_instance.search.assert_called_once_with(query='json test', document_id=None, top_k=5)
    assert json.loads(result.output) == mock_search_results
```

#### 3.2.3 Test Case: `test_cli_search_with_filters`

**Purpose:** Test CLI with `document-id` and `top-k`. **Test Implementation:**

```python
def test_cli_search_with_filters(mocker):
    runner = CliRunner()
    mock_service_instance = MagicMock()
    mock_service_instance.search.return_value = [] # Return value not critical for this call check
    mocker.patch('khive.cli.khive_reader.DocumentSearchService', return_value=mock_service_instance)
    mocker.patch('khive.cli.khive_reader.EmbeddingGenerator')
    mocker.patch('khive.cli.khive_reader.DocumentChunkRepository')

    doc_id_str = str(uuid7())
    from khive.cli import khive_reader
    result = runner.invoke(khive_reader.reader_cli, [
        'search', '--query', 'filters test', '--document-id', doc_id_str, '--top-k', '3'
    ])

    assert result.exit_code == 0
    # The CLI will pass doc_id_str as string, service might convert to UUID
    mock_service_instance.search.assert_called_once_with(query='filters test', document_id=doc_id_str, top_k=3)
```

#### 3.2.4 Test Case: `test_cli_search_missing_query`

**Purpose:** Test required query argument. **Test Implementation:**

```python
def test_cli_search_missing_query(mocker):
    runner = CliRunner()
    # No need to mock service as it shouldn't be called
    from khive.cli import khive_reader
    result = runner.invoke(khive_reader.reader_cli, ['search'])

    assert result.exit_code != 0 # Click typically exits with 2 for usage errors
    assert "Missing option '--query'" in result.output # Or similar error from Click
```

## 4. Integration Tests

Not planned for this specific issue, as per IP. Focus is on unit tests with
mocks.

## 5. API Tests

Not applicable (CLI command, not an API endpoint).

## 6. Error Handling Tests

Covered within unit tests for `DocumentSearchService` (e.g.,
`test_search_embedding_generator_exception`) and CLI tests (e.g.,
`test_cli_search_missing_query`).

## 7. Performance Tests

Not in scope for this issue.

## 8. Mock Implementation Details

Mocks will be created using `unittest.mock.MagicMock` or `pytest-mock`'s
`mocker` fixture.

- `Mock(EmbeddingGenerator)`: `generate_embedding` method will be mocked to
  return a predefined list of floats.
- `Mock(DocumentChunkRepository)`: `search_similar_chunks` method will be mocked
  to return a predefined list of `DocumentChunk`-like dictionaries.

## 9. Test Data

- Sample queries: "test query", "filter query", "top_k query", "empty query",
  "exception query", "cli test", "json test", "filters test".
- Sample `document_id`: Generated using `uuid_extensions.uuid7()`.
- Sample `top_k` values: 5 (default), 3.
- Mocked embeddings: `[0.1, 0.2, 0.3]`.
- Mocked search results: Lists of dictionaries representing simplified document
  chunks, e.g.,
  `[{"id": "...", "document_id": "...", "text_content": "...", "score": ...}]`.

## 10. Helper Functions

No specific complex test helper functions anticipated beyond standard pytest
fixtures.

## 11. Test Coverage Targets

- **Line Coverage Target:** ≥80% for
  `src/khive/reader/services/search_service.py` and relevant new code in
  [`src/khive/cli/khive_reader.py`](src/khive/cli/khive_reader.py:0).
- **Branch Coverage Target:** Aim for good branch coverage as part of the line
  coverage.

## 12. Continuous Integration

Tests will be run as part of the existing CI pipeline (assumed to use
`pytest --cov`).

## 13. Notes and Caveats

### 13.1 Known Limitations

- Tests rely on accurate mocking of `EmbeddingGenerator` and
  `DocumentChunkRepository` interfaces. Changes in these interfaces would
  require test updates.
- CLI tests will mock the service layer; they won't test the full integration
  through the service to mocked repository parts within the same test, but
  rather the CLI's interaction with the service's public API.

### 13.2 Future Improvements

- If advanced search features are implemented, corresponding tests will be
  added.
- Consider adding contract tests for `EmbeddingGenerator` and
  `DocumentChunkRepository` if not already present elsewhere, to ensure mock
  behavior aligns with actual implementations.
